<link rel="import" href="../bower_components/polymer/polymer.html">

<dom-module id="assignment-admin">
    <style>

        paper-fab {
            position: absolute;
            background: #00BCD4;
            bottom: 1vh;
            right: 2vw;
        }
        #wrapperDiv paper-fab{
            position: absolute !important;
            background: #00BCD4 !important;
            bottom: 10vh !important;
            right: 2vw !important;
        }

        .main-panel {
            background-color: #eee;
            height: 100vh;
            overflow-y: hidden;
        }


    </style>

    <template>

        <div style="border-left: 1px solid #ccc;">
            <paper-material elevation="2">
                <paper-input label="Assignment Name" on-change="namechanged" value="{{name::input}}"></paper-input>
                <paper-item>
                    <div>
                        <paper-button class="btn" on-tap="showDialogEffective" raised>Effective Date</paper-button>
                        {{dateFormat(effectiveDate, 'LL')}}
                    </div>
                </paper-item>
                <paper-item>
                    <div>
                        <paper-button class="btn" on-tap="showDialogExpiry" raised>Expiration Date</paper-button>
                        {{dateFormat(expirationDate, 'LL')}}
                    </div>
                </paper-item>
                <paper-material elevation="2">
                    <paper-fab icon="icons:add" on-tap="addWord"></paper-fab>
                </paper-material>
            </paper-material>

            <!-- Date Pop-Up -->
            <paper-dialog id="dialog" class="paper-date-picker-dialog" modal on-iron-overlay-closed="dismissDialog">
                <paper-date-picker id="picker" date="{{date}}"></paper-date-picker>
                <div class="buttons">
                    <paper-button dialog-dismiss>Cancel</paper-button>
                    <paper-button dialog-confirm>OK</paper-button>
                </div>
            </paper-dialog>

            <template is="dom-repeat" items="{{words}}">
                <paper-material>
                    <paper-item>
                        <paper-item-body hidden={{item.editing}} three-line class="layout vertical">
                            <div>{{item.word}}</div>
                            <div secondary>{{item.sentence}}</div>
                        </paper-item-body>
                        <paper-item-body hidden={{!item.editing}} three-line class="layout vertical">
                            <paper-input label="Spelling Word" value="{{item.word::input}}"></paper-input>
                            <paper-input label="Example usage in sentence" value="{{item.sentence::input}}"></paper-input>
                        </paper-item-body>
                        <div id="wrapperDiv">
                            <paper-fab class='paper-fab-cancel' hidden={{!item.editing}} mini icon="icons:close" on-tap="doDelete"></paper-fab>
                        </div>
                        <paper-fab hidden={{!item.editing}} mini icon="icons:done" on-tap="doEdit"></paper-fab>
                        <paper-fab hidden={{item.editing}} mini icon="editor:mode-edit" on-tap="doEdit"></paper-fab>
                    </paper-item>
                </paper-material>
            </template>
            <paper-item-body three-line class="layout vertical">
                <paper-dialog-scrollable>{{JSON}}</paper-dialog-scrollable>
            </paper-item-body>
        </div>
    </template>
    <script>
        Polymer({
            is: 'assignment-admin',
            properties: {
                name: "",
                AssignmentID: -1,
                words: [],
                effectiveDate: "",
                expirationDate: "",
                JSON: {
                    type: String,
                    computed: "convertToJson(name, words, effectiveDate, expirationDate)"
                    }
            },
            ready: function () {
                //this.name = "New Assignment";
                var self = this;
                this.words = [];
                //this.effectiveDate = new Date();
                //this.expirationDate = new Date();
                this.whichDateAmIModifying = "";
                this.AssignmentID = -1;
            },
            loadForAssignment: function (ass) {
                var self = this;
                self.words = [];
                console.log('here!!!' + ass.Description);
                var url = "http://" + document.location.hostname + ":50906/SingleAssignment.aspx?id=" + ass.AssignmentID;
                console.log("Loading " + url);
                $.get(url, function (data) {
                    console.log("got " + data);
                    self.words = [];
                    for (var i = 0; i < data.Words.length; i++) {
                        var newObj = {
                            word: data.Words[i],
                            sentence: data.Sentences[i],
                            id: i + 1
                        };
                        self.push('words', newObj);
                    }
                    self.AssignmentID = data.Id;
                    self.name = data.Name;
                    self.effectiveDate = data.EffectiveDate;
                    self.expirationDate = data.ExpirationDate;
                    console.log("done");
                });
            },
            observers: [
                'convertToJson(words.*)'
            ],
            dateFormat: function (date, format) {
                return moment(date).format(format);
            },
            dismissDialog: function (event) {
                if (event.detail.confirmed) {
                    if (this.whichDataAmIModifying == 'Effective')
                        this.effectiveDate = this.$.picker.date;
                    else
                        this.expirationDate = this.$.picker.date;
                    this.postJSON();
                }
            },
            showDialogEffective: function () {
                this.whichDataAmIModifying = 'Effective';
                this.$.dialog.toggle();
            },
            showDialogExpiry: function () {
                this.whichDataAmIModifying = 'Expiry';
                this.$.dialog.toggle();
            },
            doEdit: function (e) {
                var model = e.model;
                model.set('item.editing', !model.item.editing);
                this.postJSON();
            },
            doDelete: function (e) {
                var model = e.model;
                model.set('item.editing', !model.item.editing);
                console.log("deleting ... " + e.model.index);
                this.splice('words', e.model.index, 1);
                this.postJSON();
            },
            convertToJson: function () {
                for (var i = 0; i < this.words.length; i++)
                    this.words[i].id = i + 1;
                var myObj = {
                    name: this.name,
                    words: this.words,
                    effectiveDate: this.effectiveDate,
                    expirationDate: this.expirationDate
                }
                console.log(JSON.stringify(myObj));
                return JSON.stringify(myObj);
            },
            postJSON: function(callback) {
                var postURL = "http://" + document.location.hostname + ":50906/SingleAssignment.aspx?id=" + this.AssignmentID;
                var self = this;
                $.post(postURL, this.convertToJson()).done(function () {
                    console.log("SUCCESS! Uploaded to server.");
                    if (callback != undefined)
                        callback(self);
                })
                 .fail(function () {
                     console.log("FAILED! not uploaded to server!!");
                 });
            },
            addWord: function () {
                this.push('words', {
                    word: '',
                    sentence: '',
                    editing: true
                });
            },
            namechanged: function () {
                this.postJSON(this.fireNameChangedEvent);
            },
            fireNameChangedEvent: function (self) {
                self.fire('nameChanged', { name: self.name });
            }


        });
    </script>

</dom-module>
